schema: '2.0'
stages:
  slide_download:
    cmd: python ../utils/file_transfer.py --out-csv .downloaded_slides.csv --data-path
      '/data/anapath/AprioricsSlides' --ihc-type 'PHH3' --mapping-file '../../ihc_mapping.json'
      --mask-extension '.tif' --remote-path '/media/AprioricsSlides' --slide-extension
      '.svs' --seed 42 --clean-previous --extension .svs --rel-path slides --remote-rel-path
      .
    outs:
    - path: .downloaded_slides.csv
      md5: b22086e2f3720da570407aeff2b49b12
      size: 67649
  generate_patch_csvs:
    cmd: python generate_patch_dataset.py --data-path '/data/anapath/AprioricsSlides'
      --ihc-type 'PHH3' --mapping-file '../../ihc_mapping.json' --mask-extension '.tif'
      --remote-path '/media/AprioricsSlides' --slide-extension '.svs' --seed 42 --patch-size
      256 --level 0 --overlap 0.1 --filter-pos 0 --overwrite --slidefolder /data/anapath/AprioricsSlides/slides
      --maskfolder /data/anapath/AprioricsSlides/masks --outfolder /data/anapath/AprioricsSlides/train
    deps:
    - path: .downloaded_slides.csv
      md5: b22086e2f3720da570407aeff2b49b12
      size: 67649
    - path: /data/anapath/AprioricsSlides/masks/PHH3
      md5: 0112823145aea68d82e7b628c73e15ca.dir
      size: 243129631097
      nfiles: 485
    outs:
    - path: /data/anapath/AprioricsSlides/train/PHH3/256_0/patch_csvs
      md5: 3cf5ae7e9c3f8b840e2c87ba2293281c.dir
      size: 1149034511
      nfiles: 485
  split_dataset:
    cmd: python split_dataset.py --maskfolder /data/anapath/AprioricsSlides/masks
      --out-csv /data/anapath/AprioricsSlides/train/PHH3/splits_new.csv --data-path
      '/data/anapath/AprioricsSlides' --ihc-type 'PHH3' --mapping-file '../../ihc_mapping.json'
      --mask-extension '.tif' --remote-path '/media/AprioricsSlides' --slide-extension
      '.svs' --seed 42 --nfolds 5 --test-ratio 0.1 --update --filename 'splits_new.csv'
    deps:
    - path: .downloaded_slides.csv
      md5: b22086e2f3720da570407aeff2b49b12
      size: 67649
    - path: /data/anapath/AprioricsSlides/masks/PHH3
      md5: 0112823145aea68d82e7b628c73e15ca.dir
      size: 243129631097
      nfiles: 485
    outs:
    - path: /data/anapath/AprioricsSlides/train/PHH3/splits_new.csv
      md5: c01938788372b60bab4e023a69c64067
      size: 5979
  train:
    cmd: python train_segmentation.py --hash-file .model_hash.yaml --data-path '/data/anapath/AprioricsSlides'
      --ihc-type 'PHH3' --mapping-file '../../ihc_mapping.json' --mask-extension '.tif'
      --remote-path '/media/AprioricsSlides' --slide-extension '.svs' --seed 42 --patch-size
      224 --level 0 --gpu 0 --batch-size 32 --lr 0.0002 --wd 0.01 --epochs 20 --num-workers
      32 --scheduler 'one-cycle' --model 'unet/resnet50' --loss 'bce' --fold 0 --p_pos
      0.9 --splitfile splits_new.csv --base-size 256 --slidefolder /data/anapath/AprioricsSlides/slides
      --maskfolder /data/anapath/AprioricsSlides/masks --trainfolder /data/anapath/AprioricsSlides/train
    deps:
    - path: /data/anapath/AprioricsSlides/train/PHH3/256_0/patch_csvs
      md5: 3cf5ae7e9c3f8b840e2c87ba2293281c.dir
      size: 1149034511
      nfiles: 485
    - path: /data/anapath/AprioricsSlides/train/PHH3/splits_new.csv
      md5: c01938788372b60bab4e023a69c64067
      size: 5979
    outs:
    - path: .model_hash.yaml
      md5: 9683ddfefb4b2d61df9ddbf7a4596f3e
      size: 39
    - path: /data/anapath/AprioricsSlides/train/logs
      md5: 9d54c73ee280f1ed835844eea426202f.dir
      size: 20851018379
      nfiles: 36
  evaluate:
    cmd: python predict_export_geojsons.py --outfolder /data/anapath/AprioricsSlides/evaluate
      --slidefolder /data/anapath/AprioricsSlides/slides --maskfolder /data/anapath/AprioricsSlides/masks
      --trainfolder /data/anapath/AprioricsSlides/train --version 28766d6cd6a54e32b5d0fd5887b9d254
      --splitfile splits_new.csv --base-size 256 --data-path '/data/anapath/AprioricsSlides'
      --ihc-type 'PHH3' --mapping-file '../../ihc_mapping.json' --mask-extension '.tif'
      --remote-path '/media/AprioricsSlides' --slide-extension '.svs' --seed 42 --patch-size
      224 --level 0 --gpu 0 --batch-size 32 --lr 0.0002 --wd 0.01 --epochs 20 --num-workers
      32 --scheduler 'one-cycle' --model 'unet/resnet50' --loss 'bce' --fold 0 --p_pos
      0.9 --area-threshold 50
    deps:
    - path: .model_hash.yaml
      md5: 9683ddfefb4b2d61df9ddbf7a4596f3e
      size: 39
    - path: /data/anapath/AprioricsSlides/train/logs
      md5: 9d54c73ee280f1ed835844eea426202f.dir
      size: 20851018379
      nfiles: 36
    outs:
    - path: /data/anapath/AprioricsSlides/evaluate/PHH3/28766d6cd6a54e32b5d0fd5887b9d254
      md5: fcea86f7598c461a18b088a0c28a6a58.dir
      size: 108687795
      nfiles: 177
  evaluate_upload:
    cmd: rsync /data/anapath/AprioricsSlides/evaluate/PHH3/28766d6cd6a54e32b5d0fd5887b9d254/
      /media/AprioricsSlides/evaluate/PHH3/28766d6cd6a54e32b5d0fd5887b9d254/
    deps:
    - path: /data/anapath/AprioricsSlides/evaluate/PHH3/28766d6cd6a54e32b5d0fd5887b9d254/
      md5: fcea86f7598c461a18b088a0c28a6a58.dir
      size: 108687795
      nfiles: 177
