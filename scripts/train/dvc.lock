schema: '2.0'
stages:
  slide_download:
    cmd: python ../utils/file_transfer.py --out-csv .downloaded_slides.csv --data-path
      '/data/anapath/AprioricsSlides' --ihc-type 'AE1AE3' --mapping-file '../../ihc_mapping.json'
      --mask-extension '.tif' --remote-path '/media/AprioricsSlides' --slide-extension
      '.svs' --seed 42 --clean-previous --add-tree --extension .svs --rel-path slides
      --remote-rel-path .
    outs:
    - path: .downloaded_slides.csv
      md5: 2a3cb2b8f2e1ab9497a6a8c2d653c678
      size: 71812
  generate_patch_csvs:
    cmd: python generate_patch_dataset.py --data-path '/data/anapath/AprioricsSlides'
      --ihc-type 'AE1AE3' --mapping-file '../../ihc_mapping.json' --mask-extension
      '.tif' --remote-path '/media/AprioricsSlides' --slide-extension '.svs' --seed
      42 --patch-size 256 --level 0 --overlap -2 --filter-pos 0 --overwrite --slidefolder
      /data/anapath/AprioricsSlides/slides --maskfolder /data/anapath/AprioricsSlides/masks
      --outfolder /data/anapath/AprioricsSlides/train
    deps:
    - path: .downloaded_slides.csv
      md5: 2a3cb2b8f2e1ab9497a6a8c2d653c678
      size: 71812
    - path: /data/anapath/AprioricsSlides/masks/AE1AE3
      md5: 8e5f2f60b7856059f8b9aaa704ad6d18.dir
      size: 502984407478
      nfiles: 488
    outs:
    - path: /data/anapath/AprioricsSlides/train/AE1AE3/256_0/patch_csvs
      md5: 7fd6d95a759e3a7d0839ede616309e46.dir
      size: 96247110
      nfiles: 488
  split_dataset:
    cmd: python split_dataset.py --maskfolder /data/anapath/AprioricsSlides/masks
      --out-csv /data/anapath/AprioricsSlides/train/AE1AE3/splits.csv --data-path
      '/data/anapath/AprioricsSlides' --ihc-type 'AE1AE3' --mapping-file '../../ihc_mapping.json'
      --mask-extension '.tif' --remote-path '/media/AprioricsSlides' --slide-extension
      '.svs' --seed 42 --nfolds 5 --test-ratio 0.1 --update --filename 'splits.csv'
    deps:
    - path: .downloaded_slides.csv
      md5: a9cd34b77800068fa1ad8eff1ce98fb9
      size: 134370
    - path: /data/anapath/AprioricsSlides/masks/AE1AE3
      md5: 8e5f2f60b7856059f8b9aaa704ad6d18.dir
      size: 502984407478
      nfiles: 488
    outs:
    - path: /data/anapath/AprioricsSlides/train/AE1AE3/splits.csv
      md5: f0b16a3689d99b3601fc1a6ade1effb4
      size: 6015
  train:
    cmd: python train_segmentation.py --hash-file .model_hash.yaml --data-path '/data/anapath/AprioricsSlides'
      --ihc-type 'AE1AE3' --mapping-file '../../ihc_mapping.json' --mask-extension
      '.tif' --remote-path '/media/AprioricsSlides' --slide-extension '.svs' --seed
      42 --patch-size 224 --level 0 --gpu 0 --batch-size 32 --lr 0.0002 --wd 0.01
      --epochs 5 --num-workers 32 --scheduler 'one-cycle' --model 'unet/resnet50'
      --loss 'bce' --fold 0 --p_pos 0.9 --splitfile splits.csv --base-size 256 --slidefolder
      /data/anapath/AprioricsSlides/slides --maskfolder /data/anapath/AprioricsSlides/masks
      --trainfolder /data/anapath/AprioricsSlides/train
    deps:
    - path: /data/anapath/AprioricsSlides/train/AE1AE3/256_0/patch_csvs
      md5: 7fd6d95a759e3a7d0839ede616309e46.dir
      size: 96247110
      nfiles: 488
    - path: /data/anapath/AprioricsSlides/train/AE1AE3/splits.csv
      md5: f0b16a3689d99b3601fc1a6ade1effb4
      size: 6015
    outs:
    - path: .model_hash.yaml
      md5: 0044ea5d41908936e13d057980064f4a
      size: 39
    - path: /data/anapath/AprioricsSlides/train/logs
      md5: 324543b3fc683566c55bd1524edde6f1.dir
      size: 18272055885
      nfiles: 32
  evaluate:
    cmd: python predict_export_geojsons.py --outfolder /data/anapath/AprioricsSlides/evaluate
      --slidefolder /data/anapath/AprioricsSlides/slides --maskfolder /data/anapath/AprioricsSlides/masks
      --trainfolder /data/anapath/AprioricsSlides/train --version 2a305444d8fe415a8f32967ea5f44d57
      --splitfile splits.csv --base-size 256 --data-path '/data/anapath/AprioricsSlides'
      --ihc-type 'AE1AE3' --mapping-file '../../ihc_mapping.json' --mask-extension
      '.tif' --remote-path '/media/AprioricsSlides' --slide-extension '.svs' --seed
      42 --patch-size 224 --level 0 --gpu 0 --batch-size 32 --lr 0.0002 --wd 0.01
      --epochs 5 --num-workers 32 --scheduler 'one-cycle' --model 'unet/resnet50'
      --loss 'bce' --fold 0 --p_pos 0.9 --area-threshold 200
    deps:
    - path: .model_hash.yaml
      md5: 0044ea5d41908936e13d057980064f4a
      size: 39
    - path: /data/anapath/AprioricsSlides/train/logs
      md5: 324543b3fc683566c55bd1524edde6f1.dir
      size: 18272055885
      nfiles: 32
    outs:
    - path: /data/anapath/AprioricsSlides/evaluate/AE1AE3/2a305444d8fe415a8f32967ea5f44d57
      md5: 7be85a2d65fafeb49313f1138f1b758d.dir
      size: 1281369042
      nfiles: 177
  geojson_upload:
    cmd: python ../utils/file_transfer.py --data-path /media/AprioricsSlides --remote-path
      /data/anapath/AprioricsSlides --ihc-type PHH3 --mapping-file ../../ihc_mapping.json
      --extension .geojson --rel-path evaluate/PHH3/ded42532bb854013b19b85b14c5aabdb/geojsons
      --remote-rel-path evaluate/PHH3/ded42532bb854013b19b85b14c5aabdb/geojsons
    deps:
    - path: /data/anapath/AprioricsSlides/evaluate/PHH3/ded42532bb854013b19b85b14c5aabdb/geojsons
      md5: 9d6be7d7c6e392fceeb82aa18e0b4f36.dir
      size: 9237358
      nfiles: 73
  evaluate_upload:
    cmd: rsync -avu /data/anapath/AprioricsSlides/evaluate/AE1AE3/2a305444d8fe415a8f32967ea5f44d57
      /media/AprioricsSlides/evaluate/AE1AE3/
    deps:
    - path: /data/anapath/AprioricsSlides/evaluate/AE1AE3/2a305444d8fe415a8f32967ea5f44d57/
      md5: 7be85a2d65fafeb49313f1138f1b758d.dir
      size: 1281369042
      nfiles: 177
